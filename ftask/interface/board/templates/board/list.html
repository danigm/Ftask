{% extends "auth/profile.html" %}

{% block title %}Board list{% endblock %}

{% block header %}
{% endblock %}

{% block main_content %}

<div id="modal" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>New Board</h3>
    </div>
    <div class="modal-body">
        <form method="POST" id="board-form" class="form-horizontal" data-url="{{ url_for('board.new_board') }}">
        <div class="control-group">
            <label class="control-label" for="boardname">Board name</label>
            <div class="controls">
                <input type="text" id="boardname" name="name" placeholder="board name"/>
                <button class="btn btn-info">Add</button>
            </div>
        </div>
        </form>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal">Close</button>
    </div>
</div>

<div class="board-title">
<h3>My Boards</h3>
<a href="#" data-toggle="modal" data-target="#modal">New board...</a>
</div>

<ul id="board-list" class="unstyled bold-list">
</ul>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script type="text/template" id="board-template">
        <a href="/board/<%= id %>"><%= name %></a>
        <a href="#" class="close" onclick="delete_board('/api/boards/<%= id %>/'); return false;">&times;</a>
    </script>

    <script type="text/javascript">
        var Board = Backbone.Model.extend({
            idAttribute: "id"
        });
        var Boards = Backbone.Collection.extend({
            model: Board,
            parse: function(response) {
                var models = new Array();
                for (var i=0; i<response.meta.total; i++) {
                    var model = new Board(response.objects[i]);
                    models.push(model);
                }
                return models;
            },
            url: '/api/boards/'
        });

        var BoardView = Backbone.View.extend({
            tagName: "li",
            template: _.template($('#board-template').html()),

            initialize: function() {
                this.listenTo(this.model, 'change', this.render);
                this.listenTo(this.model, 'destroy', this.remove);
            },

            render: function() {
                this.$el.html(this.template(this.model.toJSON()));
                return this;
            },

        });
    </script>

    <script type="text/javascript">
        var boards = new Boards();
        var views = new Array();
        boards.on("add", function(l) {
            var view = new BoardView({model: l});
            $("#board-list").append(view.render().el);
            views.push(view);
        });
        boards.on("remove", function(l) {
            var view = _.find(views, function(v) { return v.model === l});
            view.remove();
            views = _.filter(views, function(v) { return v.model != l });
        });

        boards.fetch({update: true});

        ftask_form("#board-form",
                   function(data) {
                        alert("ERROR");
                   },
                   function(data) {
                        boards.fetch({update: true});
                        $("#modal").modal("hide");
                   });

        setInterval('boards.fetch({update: true})', 5000);

        function delete_board(url) {
            var token = $("#csrf_token").val();
            var req = $.ajax({url:url + '?_csrf_token='+token, type:"DELETE"});
            req.done(function(data) {
                boards.fetch({update: true});
                ftask_update_csrf();
            });
            req.fail(function(data) {
                alert("ERROR");
                ftask_update_csrf();
            });
        }
    </script>

{% endblock %}
